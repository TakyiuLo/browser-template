<!DOCTYPE html>
<html>
<head>
  <title>Example</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Do not add `link` tags-->
  <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
  <!-- Do not add `script` tags-->
  <script src="public/vendor.js" type="text/javascript" charset="utf-8" defer></script>
  <script src="public/application.js" type="text/javascript" charset="utf-8" defer></script>
</head>
<body>
  <div id="message-modal" class="message-modal d-none">
    <p id="message-modal-content" class="message-modal-content" status='normal'></p>
  </div>
  <section id="state-navbar" class="state-navbar">
    <!-- Navbar content -->
    <nav class="navbar navbar-dark bg-dark text-white">
      <h1 class="cancel-button">Nozama.com!</h1>
      <a id="login-button" class="navbar-brand" href="#">
        SignIn
      </a>
      <a id="change-password-button" class="navbar-brand d-none" href="#">
        Change Password
      </a>
      <a id="sign-out-button" class="navbar-brand d-none" href="#">
        Sign Out
      </a>
      <a id='shopping-cart-button' class="navbar-brand d-none" href="#">
        Cart
      </a>
      <a id='previous-orders-button' class="navbar-brand d-none" href="#">
        Previous Orders
      </a>
    </nav>
  </section>
  <section id="state-credentials" class="state-credentials d-none">
    <form id="sign-up-form" class="form sign-up-form">
      <legend>Sign Up</legend>
      <div class="input-group">
        <div class="input-group-prepend">
          <span class="input-group-text oi oi-envelope-closed"></span>
        </div>
        <input class="form-control" type="email" name="credentials[email]" placeholder="Email Address">
      </div>
      <div class="input-group">
        <div class="input-group-prepend">
          <span class="input-group-text oi oi-lock-locked"></span>
        </div>
        <input class="form-control" type="password" name="credentials[password]" placeholder="Password">
      </div>
      <div class="input-group">
        <div class="input-group-prepend">
          <span class="input-group-text oi oi-lock-locked"></span>
        </div>
        <input class="form-control" type="password" name="credentials[password_confirmation]" placeholder="Confirm Password">
      </div>
      <div class="input-group">
        <button class="btn btn--form sign-up-button" type="submit"><span>Register</span></button>
      </div>
    </form>
    <form id="sign-in-form" class="form sign-in-form">
      <legend>Sign In</legend>
      <div class="input-group">
        <div class="input-group-prepend">
          <span class="input-group-text oi oi-envelope-closed"></span>
        </div>
        <input class="form-control" type="email" name="credentials[email]" placeholder="Email Address">
      </div>
      <div class="input-group">
        <div class="input-group-prepend">
          <span class="input-group-text oi oi-lock-locked"></span>
        </div>
        <input class="form-control" type="password" name="credentials[password]" placeholder="Password">
      </div>
      <div class="input-group">
        <button class="btn btn--form sign-in-button" type="submit">
          <span>Login</span>
        </button>
      </div>
    </form>
  </section>
  <section id="state-change-password" class="state-change-password d-none">
    <form id="change-password-form" class="form change-password-form">
      <legend>Change Password</legend>
      <div class="input-group">
        <div class="input-group-prepend">
          <span class="input-group-text oi oi-lock-locked"></span>
        </div>
        <input class="form-control" type="password" name="passwords[old]" placeholder="Old Password">
      </div>
      <div class="input-group">
        <div class="input-group-prepend">
          <span class="input-group-text oi oi-lock-locked"></span>
        </div>
        <input class="form-control" type="password" name="passwords[new]" placeholder="New Password">
      </div>
      <div class="input-group change-password-button">
        <button class="btn btn--form" type="submit">Submit</button>
      </div>
    </form>
  </section>
  <section id="state-products" class="state-products">
    Products
    <section id="products" class="products"></section>
  </section>
  <section id="state-shopping-cart" class="state-shopping-cart d-none">
    <section class="shopping-cart-header">
      <h5>Shopping carts</h5>
    </section>
    <section id="shopping-cart" class="shopping-cart"></section>
    <section class="shopping-cart-footer">
      <h5 id="total" class='total'>
        Total:
        <span class="amount"></span>
      </h5>
      <button id="checkout" class="checkout" type="button">Checkout</button>
    </section>
  </section>
  <section id="state-previous-orders" class="state-previous-orders d-none">
    <section class="previous-orders-header">
      <h5>Previous orders</h5>
    </section>
    <section id="previous-orders" class="previous-orders"></section>
  </section>

  <!-- stripe -->
  <script src="https://checkout.stripe.com/checkout.js"></script>

  <!-- <button id="customButton">Purchase</button> -->

  <script>
  var handler = StripeCheckout.configure({
    key: 'pk_test_LWGkLPvWiwQnlpGbYoQ45aGm',
    image: 'https://stripe.com/img/documentation/checkout/marketplace.png',
    locale: 'auto',
    token: function(token) {
      // You can access the token ID with `token.id`.
      // Get the token ID to your server-side code for use.
      console.log(token)
      // charge user
      $.ajax({
        method: 'POST',
        url: 'http://localhost:4741/charge',
        data: {
          stripeToken: 'tok_visa'
        }
      })
      .then((response) => {
        console.log('stripe charge: ', response)
        const openOrderId = $('#state-shopping-cart').attr('data-openOrderId')
        const token = $('#state-shopping-cart').attr('data-token')
        $('#state-shopping-cart').removeAttr('data-token')
        // close openOrder
        $.ajax({
          method: 'PATCH',
          url: 'http://localhost:4741/orders/' + openOrderId,
          headers: {
            'Authorization': 'Token token=' + token
          },
          data: {
            order: {
              status: 'closed'
            }
          }
        })
        .then((response) => {
          const messageModal = (message, status) => {
            // Modal status: normal, success, fail
            $('#message-modal .message-modal-content').text(message)
            $('#message-modal .message-modal-content').attr('status', status)
            $('#message-modal').removeClass('d-none')
            setTimeout(() => {
              $('#message-modal').addClass('d-none')
            }, 1500)
          }

          messageModal('Good Job Fuck off now', 'success')
          $('#login-button').removeClass('d-none')
          $('#state-products').removeClass('d-none')
          $('#change-password-button').addClass('d-none')
          $('#sign-out-button').addClass('d-none')
          $('#shopping-cart-button').addClass('d-none')
          $('#previous-orders-button').addClass('d-none')
          $('#state-shopping-cart').addClass('d-none')
          $('#state-previous-orders').addClass('d-none')
        })
      })
      .catch(console.err)
  }
})

  document.getElementById('checkout').addEventListener('click', function(e) {
    // Open Checkout with further options:
    handler.open({
      name: 'Stripe.com',
      description: '2 widgets',
      zipCode: true,
      amount: 2000
    });
    e.preventDefault();
  });

  // Close Checkout on page navigation:
  window.addEventListener('popstate', function() {
    handler.close();
  });
  </script>
</body>
</html>
